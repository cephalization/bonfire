# syntax=docker/dockerfile:1.7

FROM node:24-bookworm AS pruner

WORKDIR /repo
ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0

RUN corepack enable \
  && corepack prepare pnpm@10.0.0 --activate

COPY . .

RUN pnpm dlx turbo@2.8.0 prune @bonfire/web --docker


FROM node:24-bookworm AS builder

WORKDIR /app
ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0
ENV PNPM_HOME=/pnpm
ENV PATH=$PNPM_HOME:$PATH

RUN corepack enable \
  && corepack prepare pnpm@10.0.0 --activate \
  && pnpm config set store-dir /pnpm/store

COPY --from=pruner /repo/out/json/ ./
COPY --from=pruner /repo/out/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=pruner /repo/out/pnpm-workspace.yaml ./pnpm-workspace.yaml

RUN pnpm install --frozen-lockfile

COPY --from=pruner /repo/out/full/ ./
COPY --from=pruner /repo/tsconfig.json ./tsconfig.json

RUN pnpm --filter @bonfire/web build


FROM nginx:alpine AS runtime

COPY docker/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/packages/web/dist/ /usr/share/nginx/html/

EXPOSE 80
