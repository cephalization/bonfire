# Development overrides
# Usage: docker compose -f docker/docker-compose.yml -f docker/docker-compose.dev.yml up

services:
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api.dev
    image: bonfire-api:dev
    ports:
      - "3000:3000" # API server
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      # Hot reload: mount source code
      - ../packages/api:/app/packages/api:cached
      - ../packages/sdk:/app/packages/sdk:cached
      - ../packages/cli:/app/packages/cli:cached

      # Dev DX: mount local agent image artifacts
      # After running ./scripts/build-agent-image-docker.sh, the UI can register:
      #   /app/images/agent-kernel
      #   /app/images/agent-rootfs.ext4
      - ../images:/app/images:ro

      # Data persistence
      - bonfire-data:/var/lib/bonfire
      - /dev/kvm:/dev/kvm
    environment:
      NODE_ENV: development
      DATABASE_URL: /var/lib/bonfire/bonfire.db
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-dev-secret-do-not-use-in-production}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3000}
      INITIAL_ADMIN_EMAIL: ${INITIAL_ADMIN_EMAIL:-admin@example.com}
      INITIAL_ADMIN_PASSWORD: ${INITIAL_ADMIN_PASSWORD:-admin123}
      INITIAL_ADMIN_NAME: ${INITIAL_ADMIN_NAME:-Admin}
    stdin_open: true
    tty: true

  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web.dev
    image: bonfire-web:dev
    ports:
      - "5173:5173" # Vite dev server
      - "5174:5174" # Vite HMR websocket
    volumes:
      - ../packages/web:/app/packages/web:cached
    environment:
      NODE_ENV: development
      PROXY_API_TARGET: http://api:3000
    depends_on:
      api:
        condition: service_healthy
    stdin_open: true
    tty: true

volumes: {}
